{% extends "layouts/base.html.twig" %}

{% block title %}Statistics - {{ app_name }}
{% endblock %}

{% block body %}
	<div class="container mt-4">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<h1>Statistics</h1>
		</div>

        <div class="mb-4">
            <form action="statistics" method="GET">
                <div class="row">
                    <div class="col-md-5 mb-3">
                        <label for="date_from" class="form-label">Date From</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" required value="{{ query.date_from ?? '-7 days'|date('Y-m-d') }}">
                    </div>
                    <div class="col-md-5 mb-3">
                        <label for="date_to" class="form-label">Date To</label>
                        <input type="date" class="form-control" id="date_to" name="date_to" required value="{{ query.date_to ?? 'now'|date('Y-m-d') }}">
                    </div>
                </div>
                <div class="mb-3">
                    <button type="submit" class="btn btn-primary">Display Balance</button>
                </div>
            </form>
        </div>

		<div
			class="row">
			<!-- Top 10 Balance Chart -->
			<div class="col-md-6 mb-4">
				<div class="card shadow-sm">
					<div class="card-header">
						<h5 class="mb-0">Top 10 Clients by Balance</h5>
					</div>
					<div class="card-body">
						<canvas id="balanceChart"></canvas>
					</div>
				</div>
			</div>

			<!-- Top 10 Volume Chart -->
			<div class="col-md-6 mb-4">
				<div class="card shadow-sm">
					<div class="card-header">
						<h5 class="mb-0">Top 10 Clients by Transaction Volume</h5>
					</div>
					<div class="card-body">
						<canvas id="volumeChart"></canvas>
					</div>
				</div>
			</div>

			<!-- Transaction Type Distribution -->
			<div class="col-md-6 mb-4">
				<div class="card shadow-sm">
					<div class="card-header">
						<h5 class="mb-0">Transaction Type Distribution</h5>
					</div>
					<div class="card-body">
						<canvas id="typeDistributionChart"></canvas>
					</div>
				</div>
			</div>

            <!-- Capital Distribution -->
			<div class="col-md-6 mb-4">
				<div class="card shadow-sm">
					<div class="card-header">
						<h5 class="mb-0">Capital Distribution</h5>
					</div>
					<div class="card-body">
						<canvas id="capitalDistributionChart"></canvas>
					</div>
				</div>
			</div>

			<!-- Daily Transaction Trend -->
			<div class="col-md-6 mb-4">
				<div class="card shadow-sm">
					<div class="card-header">
						<h5 class="mb-0">Daily Transaction Trend</h5>
					</div>
					<div class="card-body">
						<canvas id="dailyTrendChart"></canvas>
					</div>
				</div>
			</div>

			<!-- Total Market Cap -->
			<div class="col-md-6 mb-4">
				<div class="card shadow-sm">
					<div class="card-header">
						<h5 class="mb-0">Total Market Cap</h5>
					</div>
					<div class="card-body">
						<canvas id="marketCapChart"></canvas>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
            const balanceData = {{topClientsByBalance | json_encode | raw}};
            const volumeData = {{topClientsByVolume | json_encode | raw}};
            const typeDistributionData = {{transactionTypeDistribution | json_encode | raw}};
            const dailyTrendData = {{dailyTransactionTrend | json_encode | raw}};
            const marketCapData = {{totalMarketCap | json_encode | raw}};
            const capitalDistributionData = {{capitalDistribution | json_encode | raw}};

            // Top 10 Balance Chart
            new Chart(document.getElementById('balanceChart'), {
                type: 'bar',
                data: {
                    labels: balanceData.map(c => c.name),
                    datasets: [{
                        label: 'Balance',
                        data: balanceData.map(c => c.balance),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Top 10 Volume Chart
            new Chart(document.getElementById('volumeChart'), {
                type: 'bar',
                data: {
                    labels: volumeData.map(c => c.name),
                    datasets: [{
                        label: 'Total Volume',
                        data: volumeData.map(c => c.volume),
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Transaction Type Distribution Chart
            new Chart(document.getElementById('typeDistributionChart'), {
                type: 'doughnut',
                data: {
                    labels: typeDistributionData.map(t => t.type === 'expense' ? 'Expenses' : 'Earnings'),
                    datasets: [{
                        data: typeDistributionData.map(t => t.total),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(75, 192, 192, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Capital Distribution Chart
            new Chart(document.getElementById('capitalDistributionChart'), {
                type: 'pie',
                data: {
                    labels: capitalDistributionData.map(c => c.name),
                    datasets: [{
                        label: 'Capital Share',
                        data: capitalDistributionData.map(c => c.percentage),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(199, 199, 199, 0.7)',
                            'rgba(83, 102, 255, 0.7)',
                            'rgba(40, 159, 64, 0.7)',
                            'rgba(215, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(199, 199, 199, 1)',
                            'rgba(83, 102, 255, 1)',
                            'rgba(40, 159, 64, 1)',
                            'rgba(215, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                callback: function(context) {
                                    return context.text + ' (' + context.raw.toFixed(1) + '%)';
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    const percentage = context.parsed.toFixed(2);
                                    const balance = capitalDistributionData[context.dataIndex].balance;
                                    return context.label + ': ' + percentage + '% (Balance: $' + parseFloat(balance).toFixed(2) + ')';
                                }
                            }
                        }
                    }
                }
            });

            // Daily Transaction Trend Chart
            new Chart(document.getElementById('dailyTrendChart'), {
                type: 'line',
                data: {
                    labels: dailyTrendData.map(d => d.date),
                    datasets: [{
                        label: 'Daily Volume',
                        data: dailyTrendData.map(d => d.total),
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Total Market Cap Chart
            new Chart(document.getElementById('marketCapChart'), {
                type: 'line',
                data: {
                    labels: marketCapData.map(d => d.day),
                    datasets: [{
                        label: 'Total Company Value',
                        data: marketCapData.map(d => d.total_company_value),
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
	    });
	</script>
{% endblock %}
